{% set title = "ููุญุฉ ุงูุฅุฏุงุฑุฉ" %}
{% extends "base.html" %}
{% block content %}
<link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css">
<section class="admin-head">
  <div>
    <h2>ููุญุฉ ุงูุฅุฏุงุฑุฉ</h2>
    <p class="muted">ุฅุฏุงุฑุฉ ุงูููุงุฏ ูุงูุฃุณุฆูุฉ ูุงูุชูุงุฑูุฑ</p>
  </div>
  {% if flash %}
    <div class="alert">{{ flash }}</div>
  {% endif %}
</section>

<section class="stats-row">
  <div class="stat-card">
    <span class="stat-label">ุนุฏุฏ ุงูููุงุฏ</span>
    <strong>{{ total_subjects }}</strong>
  </div>
  <div class="stat-card">
    <span class="stat-label">ุนุฏุฏ ุงูุฃุณุฆูุฉ</span>
    <strong>{{ total_questions }}</strong>
  </div>
  <div class="stat-card">
    <span class="stat-label">ุงูุชุฑุงุญุงุช ุฌุฏูุฏุฉ</span>
    <strong>{{ new_suggestions }}</strong>
  </div>
  <div class="stat-card">
    <span class="stat-label">ุจูุงุบุงุช ุฌุฏูุฏุฉ</span>
    <strong>{{ new_reports }}</strong>
  </div>
</section>

<div class="tabs">
  <button class="tab-btn active" data-tab="subjects">ุงูููุงุฏ</button>
  <button class="tab-btn" data-tab="questions">ุงูุฃุณุฆูุฉ</button>
  <button class="tab-btn" data-tab="suggestions">ุงูุชุฑุงุญุงุช ุงูุทูุงุจ</button>
  <button class="tab-btn" data-tab="reports">ุจูุงุบุงุช ุงูุฃุฎุทุงุก</button>
  <button class="tab-btn" data-tab="csv">ุงุณุชูุฑุงุฏ/ุชุตุฏูุฑ</button>
</div>

<section class="tab-panel active" id="tab-subjects">
  <div class="card">
    <h3>ุฅุถุงูุฉ ูุงุฏุฉ</h3>
    <form method="post" action="/admin/subjects/create" class="form inline">
      <input name="name" placeholder="ุงุณู ุงููุงุฏุฉ" required />
      <button class="btn" type="submit">ุฅุถุงูุฉ</button>
    </form>
  </div>

  <div class="card">
    <h3>ุงูููุงุฏ</h3>
    {% if subjects %}
    <div class="table">
      <div class="table-row head subjects-row">
        <span>ุงุณู ุงููุงุฏุฉ</span>
        <span>ุนุฏุฏ ุงูุฃุณุฆูุฉ</span>
        <span>ุฅุฌุฑุงุกุงุช</span>
      </div>
      {% for s in subjects %}
      <div class="table-row subjects-row">
        <span>{{ s.name }}</span>
        <span>{{ subject_count_map.get(s.id, 0) }}</span>
        <span class="actions">
          <form method="post" action="/admin/subjects/{{ s.id }}/delete" onsubmit="return confirm('ุชุฃููุฏ ุญุฐู ุงููุงุฏุฉุ')">
            <button class="btn ghost danger" type="submit">ุญุฐู</button>
          </form>
        </span>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">๐</div>
        <h3>ูุง ุชูุฌุฏ ููุงุฏ ุจุนุฏ</h3>
        <p>ุงุจุฏุฃ ุจุฅุถุงูุฉ ูุงุฏุฉ ุฌุฏูุฏุฉ.</p>
      </div>
    {% endif %}
  </div>
</section>

<section class="tab-panel" id="tab-questions">
  <div class="card">
    <h3>ุฅุถุงูุฉ ุณุคุงู</h3>
    <form method="post" action="/admin/questions/create" class="form" enctype="multipart/form-data" id="addQuestionForm">
      <div class="grid two">
        <div>
          <label>ุงููุงุฏุฉ</label>
          <select name="subject_id" required>
            {% for s in subjects %}
              <option value="{{ s.id }}">{{ s.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>ูุตุฏุฑ ุงูุณุคุงู</label>
          <select name="source" id="questionSource">
            <option value="past">ุฃุณุฆูุฉ ุงูุชุญุงูุงุช ุณุงุจูุฉ</option>
            <option value="ai">ุฃุณุฆูุฉ ูููุฏุฉ ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู</option>
          </select>
        </div>
      </div>
      <div class="grid two" id="examTypeRow">
        <div>
          <label>ููุน ุงูุงูุชุญุงู</label>
          <select name="exam_type">
            <option value="mid">ููุชุตู ุงููุตู</option>
            <option value="final">ููุงุฆู</option>
            <option value="both">ููุงููุง</option>
          </select>
        </div>
      </div>
      <label>ูุต ุงูุณุคุงู (ุงุฎุชูุงุฑู ุฅุฐุง ูุงูุช ุงูุตูุฑุฉ ููุฌูุฏุฉ)</label>
      <textarea name="question_text"></textarea>
      <label>ุตูุฑุฉ ุงูุณุคุงู (ุงุฎุชูุงุฑู)</label>
      <input type="file" id="imageInputCreate" name="image" accept="image/*" />
      <div id="cropAreaCreate" class="crop-area hidden">
        <img id="cropImageCreate" alt="ูุต ุงูุตูุฑุฉ" />
        <div class="crop-actions">
          <button class="btn ghost" type="button" id="applyCropCreate">ูุต ูุงุนุชูุงุฏ</button>
          <button class="btn ghost" type="button" id="resetCropCreate">ุฅูุบุงุก</button>
        </div>
      </div>
      <div class="grid two">
        <div>
          <label>ุงูุฎูุงุฑ A</label>
          <input name="choice_a" required />
        </div>
        <div>
          <label>ุงูุฎูุงุฑ B</label>
          <input name="choice_b" required />
        </div>
        <div>
          <label>ุงูุฎูุงุฑ C</label>
          <input name="choice_c" required />
        </div>
        <div>
          <label>ุงูุฎูุงุฑ D</label>
          <input name="choice_d" required />
        </div>
      </div>
      <div class="grid two">
        <div>
          <label>ุงูุฅุฌุงุจุฉ ุงูุตุญูุญุฉ</label>
          <select name="correct_choice">
            <option value="A">A</option>
            <option value="B">B</option>
            <option value="C">C</option>
            <option value="D">D</option>
          </select>
        </div>
        <div>
          <label>ุดุฑุญ (ุงุฎุชูุงุฑู)</label>
          <textarea name="explanation"></textarea>
        </div>
      </div>
      <button class="btn" type="submit">ุฅุถุงูุฉ ุงูุณุคุงู</button>
    </form>
  </div>

  <div class="card">
    <h3>ุงูุฃุณุฆูุฉ ุงูุฃุฎูุฑุฉ</h3>
    {% if questions %}
    <div class="filters">
      <input id="qSearch" placeholder="ุงุจุญุซ ุนู ุณุคุงู..." />
      <select id="qSubject">
        <option value="">ูู ุงูููุงุฏ</option>
        {% for s in subjects %}
          <option value="{{ s.name }}">{{ s.name }}</option>
        {% endfor %}
      </select>
      <select id="qSource">
        <option value="">ูู ุงููุตุงุฏุฑ</option>
        <option value="past">ุฃุณุฆูุฉ ุณุงุจูุฉ</option>
        <option value="ai">ุฃุณุฆูุฉ AI</option>
      </select>
      <select id="qExam">
        <option value="">ูู ุงูุงูุชุญุงูุงุช</option>
        <option value="mid">ููุชุตู</option>
        <option value="final">ููุงุฆู</option>
        <option value="both">ููุงููุง</option>
      </select>
    </div>
    <div class="table" id="questionsTable">
      <div class="table-row head q-row">
        <span>ID</span>
        <span>ุงููุงุฏุฉ</span>
        <span>ุงููุตุฏุฑ</span>
        <span>ุงูุงูุชุญุงู</span>
        <span>ุงููุนุงููุฉ</span>
        <span>ุฅุฌุฑุงุกุงุช</span>
      </div>
      {% for q in questions %}
      <div class="table-row q-row" data-id="{{ q.id }}" data-subject="{{ q.subject_name }}" data-source="{{ q.source }}" data-exam="{{ q.exam_type }}">
        <span>#{{ q.id }}</span>
        <span>{{ q.subject_name }}</span>
        <span>{{ 'ุณุงุจู' if q.source == 'past' else 'AI' }}</span>
        <span>{% if q.source == 'past' %}{{ q.exam_type }}{% else %}โ{% endif %}</span>
        <span class="truncate">{{ q.question_text or 'ุณุคุงู ุจุตูุบุฉ ุตูุฑุฉ' }}</span>
        <span class="actions">
          <a class="btn ghost" href="/admin/questions/{{ q.id }}/edit">ุชุนุฏูู</a>
          <form method="post" action="/admin/questions/{{ q.id }}/delete" onsubmit="return confirm('ุชุฃููุฏ ุญุฐู ุงูุณุคุงูุ')">
            <button class="btn ghost danger" type="submit">ุญุฐู</button>
          </form>
        </span>
      </div>
      {% endfor %}
    </div>
    <div class="pagination" id="qPagination"></div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">๐งพ</div>
        <h3>ูุง ุชูุฌุฏ ุฃุณุฆูุฉ ุจุนุฏ</h3>
        <p>ุงุจุฏุฃ ุจุฅุถุงูุฉ ุณุคุงู ุฌุฏูุฏ.</p>
      </div>
    {% endif %}
  </div>
</section>

<section class="tab-panel" id="tab-suggestions">
  <div class="card">
    <h3>ุงูุชุฑุงุญุงุช ุงูุทูุงุจ</h3>
    {% if suggestions %}
    <div class="table">
      <div class="table-row head sug-row">
        <span>#</span>
        <span>ุงูุญุงูุฉ</span>
        <span>ุงููุนุงููุฉ</span>
        <span>ุงูุชุงุฑูุฎ</span>
        <span>ุฅุฌุฑุงุกุงุช</span>
      </div>
      {% for s in suggestions %}
      <div class="table-row sug-row">
        <span>#{{ s.id }}</span>
        <span>{{ s.status }}</span>
        <span class="truncate">{{ s.question_text or s.message or 'โ' }}</span>
        <span>{{ s.created_at }}</span>
        <span class="actions">
          {% if s.type == 'question' %}
          <form method="post" action="/admin/suggestions/{{ s.id }}/publish" class="form inline">
            <select name="subject_id" required>
              {% for sub in subjects %}
                <option value="{{ sub.id }}">{{ sub.name }}</option>
              {% endfor %}
            </select>
            <select name="exam_type">
              <option value="mid">ููุชุตู ุงููุตู</option>
              <option value="final">ููุงุฆู</option>
              <option value="both">ููุงููุง</option>
            </select>
            <button class="btn" type="submit">ูุดุฑ</button>
          </form>
          {% endif %}
          <form method="post" action="/admin/suggestions/{{ s.id }}/reject" onsubmit="return confirm('ุญุฐู ุงูุงูุชุฑุงุญุ')">
            <button class="btn ghost danger" type="submit">ุญุฐู</button>
          </form>
        </span>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">๐ก</div>
        <h3>ูุง ุชูุฌุฏ ุงูุชุฑุงุญุงุช</h3>
        <p>ูุง ุชูุฌุฏ ุงูุชุฑุงุญุงุช ุญุงููุงู.</p>
      </div>
    {% endif %}
  </div>
</section>

<section class="tab-panel" id="tab-reports">
  <div class="card">
    <h3>ุจูุงุบุงุช ุงูุฃุฎุทุงุก</h3>
    {% if reports %}
    <div class="table">
      <div class="table-row head rep-row">
        <span>#</span>
        <span>ุงูุญุงูุฉ</span>
        <span>ุงูุณุคุงู</span>
        <span>ุงูุชุงุฑูุฎ</span>
        <span>ุฅุฌุฑุงุกุงุช</span>
      </div>
      {% for r in reports %}
      <div class="table-row rep-row">
        <span>#{{ r.id }}</span>
        <span>{{ r.status }}</span>
        <span class="truncate">{{ r.question_text }}</span>
        <span>{{ r.created_at }}</span>
        <span class="actions">
          <a class="btn ghost" href="/admin/questions/{{ r.question_id }}/edit">ูุชุญ ุงูุณุคุงู</a>
          <form method="post" action="/admin/reports/{{ r.id }}/resolve">
            <select name="correct_choice">
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
            <input name="explanation" placeholder="ุดุฑุญ ูุฎุชุตุฑ" />
            <button class="btn" type="submit">ุชู ุงูุญู</button>
          </form>
        </span>
      </div>
      {% endfor %}
    </div>
    {% else %}
      <div class="empty-state">
        <div class="empty-icon">๐ซ</div>
        <h3>ูุง ุชูุฌุฏ ุจูุงุบุงุช</h3>
        <p>ูุง ุชูุฌุฏ ุจูุงุบุงุช ุญุงููุงู.</p>
      </div>
    {% endif %}
  </div>
</section>

<section class="tab-panel" id="tab-csv">
  <div class="card">
    <h3>ุชุตุฏูุฑ/ุงุณุชูุฑุงุฏ CSV</h3>
    <div class="grid two">
      <div>
        <h4>ุชุตุฏูุฑ</h4>
        <p class="muted small">ูุชุถูู ุฌููุน ุงูุฃุณุฆูุฉ ูุงูุญููู ุงูุฃุณุงุณูุฉ.</p>
        <a class="btn" href="/admin/export.csv">ุชุตุฏูุฑ CSV</a>
      </div>
      <div>
        <h4>ุงุณุชูุฑุงุฏ</h4>
        <form method="post" action="/admin/import.csv" class="form" enctype="multipart/form-data">
          <input type="file" name="file" accept=".csv" required />
          <button class="btn ghost" type="submit">ุงุณุชูุฑุงุฏ</button>
        </form>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script>
  const tabs = document.querySelectorAll('.tab-btn');
  const panels = {
    subjects: document.getElementById('tab-subjects'),
    questions: document.getElementById('tab-questions'),
    suggestions: document.getElementById('tab-suggestions'),
    reports: document.getElementById('tab-reports'),
    csv: document.getElementById('tab-csv'),
  };
  tabs.forEach((t) => {
    t.addEventListener('click', () => {
      tabs.forEach((b) => b.classList.remove('active'));
      Object.values(panels).forEach((p) => p.classList.remove('active'));
      t.classList.add('active');
      panels[t.dataset.tab].classList.add('active');
    });
  });

  const sourceSelect = document.getElementById('questionSource');
  const examRow = document.getElementById('examTypeRow');
  const toggleExam = () => {
    if (sourceSelect.value === 'ai') {
      examRow.style.display = 'none';
    } else {
      examRow.style.display = 'grid';
    }
  };
  if (sourceSelect && examRow) {
    sourceSelect.addEventListener('change', toggleExam);
    toggleExam();
  }

  (function () {
    const input = document.getElementById('imageInputCreate');
    const area = document.getElementById('cropAreaCreate');
    const img = document.getElementById('cropImageCreate');
    const applyBtn = document.getElementById('applyCropCreate');
    const resetBtn = document.getElementById('resetCropCreate');
    if (!input || !area || !img || !applyBtn || !resetBtn) return;
    let cropper = null;

    input.addEventListener('change', () => {
      const file = input.files && input.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      img.src = url;
      area.classList.remove('hidden');
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, { viewMode: 1, autoCropArea: 0.8 });
    });

    applyBtn.addEventListener('click', () => {
      if (!cropper) return;
      cropper.getCroppedCanvas().toBlob((blob) => {
        if (!blob) return;
        const file = new File([blob], 'question.jpg', { type: 'image/jpeg' });
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;
        area.classList.add('hidden');
      }, 'image/jpeg', 0.9);
    });

    resetBtn.addEventListener('click', () => {
      if (cropper) cropper.destroy();
      cropper = null;
      area.classList.add('hidden');
      input.value = '';
    });
  })();

  const qRows = Array.from(document.querySelectorAll('.q-row'));
  const qPagination = document.getElementById('qPagination');
  const qSearch = document.getElementById('qSearch');
  const qSubject = document.getElementById('qSubject');
  const qSource = document.getElementById('qSource');
  const qExam = document.getElementById('qExam');
  let page = 1;
  const perPage = 20;

  function filterRows() {
    const text = (qSearch?.value || '').toLowerCase();
    const subject = qSubject?.value || '';
    const source = qSource?.value || '';
    const exam = qExam?.value || '';
    return qRows.filter((row) => {
      const rText = row.querySelector('.truncate')?.textContent?.toLowerCase() || '';
      const rSubject = row.dataset.subject || '';
      const rSource = row.dataset.source || '';
      const rExam = row.dataset.exam || '';
      if (text && !rText.includes(text)) return false;
      if (subject && rSubject !== subject) return false;
      if (source && rSource !== source) return false;
      if (exam && rExam !== exam) return false;
      return true;
    });
  }

  function renderTable() {
    const rows = filterRows();
    const totalPages = Math.max(1, Math.ceil(rows.length / perPage));
    page = Math.min(page, totalPages);
    qRows.forEach((r) => (r.style.display = 'none'));
    rows.slice((page - 1) * perPage, page * perPage).forEach((r) => (r.style.display = 'grid'));
    qPagination.innerHTML = '';
    if (totalPages > 1) {
      for (let i = 1; i <= totalPages; i++) {
        const a = document.createElement('a');
        a.className = 'page' + (i === page ? ' active' : '');
        a.textContent = i;
        a.href = '#';
        a.onclick = (e) => {
          e.preventDefault();
          page = i;
          renderTable();
        };
        qPagination.appendChild(a);
      }
    }
    if (qSource && qExam) {
      qExam.style.display = qSource.value === 'past' ? 'inline-block' : '';
    }
  }

  [qSearch, qSubject, qSource, qExam].forEach((el) => {
    if (!el) return;
    el.addEventListener('input', () => { page = 1; renderTable(); });
    el.addEventListener('change', () => { page = 1; renderTable(); });
  });
  renderTable();
</script>
{% endblock %}
